<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSocket STOMP Test</title>
</head>
<body>
<h2>WebSocket STOMP Test</h2>
<p>Status: <span id="status">Disconnected</span></p>
<input type="text" id="messageInput" placeholder="Enter message">
<button onclick="sendMsg()">Send</button>
<ul id="messages"></ul>

<script>
    let socket = null;

    function connect() {
        socket = new WebSocket('ws://localhost:8080/ws');

        socket.onopen = () => {
            document.getElementById('status').textContent = 'Connected';
            // STOMP CONNECT
            socket.send("CONNECT\n\n\0");
            // STOMP SUBSCRIBE
            socket.send("SUBSCRIBE\nid:sub-0\ndestination:/topic/echo_response\n\n\0");
        };

        socket.onmessage = (event) => {
            const msg = event.data;
            if (msg.startsWith('MESSAGE')) {
                // Извлекаем JSON из тела
                const payload = msg.split('\n\n')[1]?.split('\0')[0];
                try {
                    const obj = JSON.parse(payload);
                    showMessage(obj.content);
                } catch (e) {
                    showMessage(payload); // если это строка
                }
            }
        };

        socket.onerror = () => {
            document.getElementById('status').textContent = 'Error';
        };
    }

    function sendMsg() {
        const text = document.getElementById('messageInput').value;
        const json = JSON.stringify({content: text});
        const stomp = "SEND\ndestination:/app/echo\ncontent-type:application/json\n\n" + json + "\n\0";
        socket.send(stomp);
        document.getElementById('messageInput').value = '';
    }

    function showMessage(text) {
        const ul = document.getElementById('messages');
        const li = document.createElement('li');
        li.textContent = text;
        ul.appendChild(li);
    }

    window.onload = connect;
</script>
</body>
</html>